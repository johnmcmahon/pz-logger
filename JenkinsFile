#!/usr/bin/groovy

node {
  def root = pwd()
  def mvn = tool 'M3'
  def sonarUrl = "https://sonar.gs.mil"
  def golangTool = tool 'golang_1.7'
  
  // Getting the GO environment ready along with defining GIT credentials
    stage('Setup') {
        deleteDir()
        // github is open gitlab requires credentials to clone
        if(env.GITLAB_CREDS) {
          git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}", credentialsId: "${env.GITLAB_CREDS}"
        } else {
          git url: "${env.GIT_URL}", branch: "${env.GIT_BRANCH}"
        }
        
        withEnv([
           "PATH+=${golangTool}/bin:${root}/gopath/bin",
            "GOROOT=${golangTool}",
            "GOPATH=${root}/gopath"
        ]) {
            sh """
              mkdir -p ${root}/gopath/bin ${root}/gopath/pkg ${root}/gopath/src
              go version
            """
        }
    }
    stage('Archive') {
        withEnv([
           "PATH+=${golangTool}/bin:${root}/gopath/bin",
            "GOROOT=${golangTool}",
            "GOPATH=${root}/gopath"
        ]) {
           sh """
             mkdir -p ${GOPATH}/src/github.com/venicegeo/pz-logger
             find . -maxdepth 1 -mindepth 1 -not -name gopath -exec mv '{}' gopath/src/github.com/venicegeo/pz-logger/ \\;
             cd "\$GOPATH/src/github.com/venicegeo/pz-logger"
             go install
             cp glide.lock ${root}/glide.lock
             cp glide.yaml ${root}/glide.yaml
             cd logger
             go test -v -coverprofile=${root}/logger.cov
             cd ${root}
             go tool cover -func=logger.cov -o logger.cov.txt
             
             cp \$GOPATH/bin/pz-logger ${root}/pz-logger
              tar -cvzf pz-logger.tgz \
                pz-logger \
                *.cov \
                *.cov.txt \
                glide.lock \
                glide.yaml
           """
        }
    }    
}
